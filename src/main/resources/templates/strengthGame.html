<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Tama Gargoyles â€“ Strength Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: #f4f4f4;
            color: #333;
            font-family: sans-serif;
            flex-direction: column;
            margin: 0;
        }

        h1 { margin-bottom: 10px; }

        .instructions {
            font-size: 1.1em;
            text-align: center;
            margin-bottom: 20px;
        }

        .percentage-display {
            font-size: 1.6rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        #timerDisplay {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 15px;
        }

        /* Wrapper for meter + buttons */
        .meter-wrapper {
            position: relative;
            width: 120px;
            height: 300px;
            margin: 0 auto;
        }

        .meter-container {
            width: 40px;
            height: 100%;
            border: 3px solid #333;
            margin: 0 auto;
            position: relative;
            background-color: #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .meter-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 0%;
            background-color: green;
            transition: height 0.1s linear, background-color 0.3s;
        }

        .control-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 65px;
            height: 65px;
            font-size: 2.2rem;   /* slightly larger */
            font-weight: bold;
            font-family: system-ui, sans-serif;
            background: white;
            color: #333;
            border: 3px solid #333;
            border-radius: 50%;
            cursor: pointer;
            touch-action: manipulation;
            box-shadow: 0 4px #999;
        }

        .control-btn:active {
            box-shadow: 0 2px #666;
            transform: translateY(-48%);
        }

        #leftBtn { left: -85px; }
        #rightBtn { right: -85px; }

        #status {
            margin-top: 25px;
            font-size: 1.3rem;
            font-weight: bold;
            color: #d32f2f;
        }

        @media (max-width: 480px) {
            .meter-wrapper { height: 250px; }
            #leftBtn { left: -70px; }
            #rightBtn { right: -70px; }
        }
    </style>
</head>
<body>

<h1>Build Your Strength!</h1>

<p class="instructions">
    Fill the meter by pressing <strong>Left Arrow</strong> and <strong>Right Arrow</strong> alternately!
</p>

<div id="timerDisplay">Time: 0 secs</div>

<div id="percentageDisplay" class="percentage-display">0%</div>

<div class="meter-wrapper">
    <button class="control-btn" id="leftBtn">â—€</button>

    <div class="meter-container">
        <div id="meterFill" class="meter-fill"></div>
    </div>

    <button class="control-btn" id="rightBtn">â–¶ï¸Ž</button>
</div>

<p id="status"></p>

<script th:inline="javascript">
    const MAX_STRENGTH = 100;
    const INCREASE_AMOUNT = 3.5;
    const DECREASE_RATE = 1.5;
    const TICK_RATE = 100;
    const MAX_INTERVAL = 400;

    let strength = 0;
    let lastInput = null;
    let lastPressTime = 0;
    let gameComplete = false;

    // Time variables
    const startTime = Date.now();
    const timerDisplay = document.getElementById("timerDisplay");
    const meterFill = document.getElementById("meterFill");
    const statusText = document.getElementById("status");
    const percentageDisplay = document.getElementById("percentageDisplay");

    // Get Gargoyle ID from Thymeleaf
    const gargoyleId = [[${gargoyleId}]];

    function updateUI() {
        meterFill.style.height = strength + "%";
        percentageDisplay.textContent = Math.floor(strength) + "%";

        // Color Feedback
        if (strength > 80) meterFill.style.backgroundColor = "#ff1744"; // Red
        else if (strength > 40) meterFill.style.backgroundColor = "#ff9100"; // Orange
        else meterFill.style.backgroundColor = "#00e676"; // Green

        // Live Timer Update
        if (!gameComplete) {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            timerDisplay.textContent = "Time: " + (mins > 0 ? mins + " min " + secs + " secs" : secs + " secs");
        }
    }

    function handleInput(input) {
        if (gameComplete) return;
        if (input === lastInput) return; // Must alternate buttons

        const now = Date.now();
        lastInput = input;
        lastPressTime = now;

        strength = Math.min(MAX_STRENGTH, strength + INCREASE_AMOUNT);
        updateUI();

        if (strength >= MAX_STRENGTH) {
            completeGame();
        }
    }

    function completeGame() {
        gameComplete = true;
        const totalSeconds = Math.floor((Date.now() - startTime) / 1000);

        strength = MAX_STRENGTH;
        updateUI();
        statusText.textContent = "ðŸ’ª MAXIMUM STRENGTH!";

        // 1. Background Save for Stats
        fetch("/minigame/strength/complete", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': [[${_csrf.token}]]
            },
            body: JSON.stringify({
                gargoyleId: gargoyleId,
                survivalTime: totalSeconds
            })
        }).then(() => {
            // 2. Redirect to the STRENGTH result logic
            setTimeout(() => {
                window.location.href = "/minigame/strength/result-page?time=" + totalSeconds + "&gargoyleId=" + gargoyleId;
            }, 1000);
        });
    }

    // Input Listeners
    document.addEventListener("keydown", (e) => {
        if (e.code === "ArrowLeft") handleInput("LEFT");
        if (e.code === "ArrowRight") handleInput("RIGHT");
    });

    document.getElementById("leftBtn").addEventListener("pointerdown", () => handleInput("LEFT"));
    document.getElementById("rightBtn").addEventListener("pointerdown", () => handleInput("RIGHT"));

    // Gravity: Meter drains over time
    setInterval(() => {
        if (gameComplete) return;
        if (strength > 0) {
            strength = Math.max(0, strength - DECREASE_RATE);
            updateUI();
        }
    }, TICK_RATE);
</script>

</body>
</html>