<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Tama Gargoyles â€“ Strength Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Unified mini-game CSS -->
    <link rel="stylesheet" th:href="@{/css/minigame.css}" />
</head>

<body class="minigame">

<div class="minigame-container">
    <div class="minigame-panel">

        <h1>Build Your Strength!</h1>

        <p class="instructions">
            Fill the meter by pressing Left Arrow and Right Arrow alternately!
        </p>

        <div id="timerDisplay">Time: 0 secs</div>
        <div id="percentageDisplay" class="percentage-display">0%</div>

        <div class="meter-wrapper">
            <button class="control-btn" id="leftBtn">â—€</button>

            <div class="meter-container">
                <div id="meterFill" class="meter-fill"></div>
            </div>

            <button class="control-btn" id="rightBtn">â–¶ï¸Ž</button>
        </div>

        <p id="status"></p>

        <div class="minigame-cancel">
            <button id="cancelBtn">Cancel</button>
        </div>


    </div>
</div>

<script th:inline="javascript">
    const MAX_STRENGTH = 100;
    const INCREASE_AMOUNT = 3.5;
    const DECREASE_RATE = 1.5;
    const TICK_RATE = 100;

    let strength = 0;
    let lastInput = null;
    let gameComplete = false;
    let running = false;

    // Time variables
    startTime = Date.now();
    const timerDisplay = document.getElementById("timerDisplay");
    const meterFill = document.getElementById("meterFill");
    const statusText = document.getElementById("status");
    const percentageDisplay = document.getElementById("percentageDisplay");

    const gargoyleId = [[${gargoyleId}]];

    function updateUI() {
        meterFill.style.height = strength + "%";
        percentageDisplay.textContent = Math.floor(strength) + "%";

        if (strength > 80) meterFill.style.backgroundColor = "#ff1744";
        else if (strength > 40) meterFill.style.backgroundColor = "#ff9100";
        else meterFill.style.backgroundColor = "#00e676";

        if (!gameComplete) {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            timerDisplay.textContent = "Time: " + (mins > 0 ? mins + " min " + secs + " secs" : secs + " secs");
        }
    }

    function handleInput(input) {
        if (gameComplete);
        if (!running){
            running = true;
            startTime = Date.now();
            setInterval(() => {
                if (gameComplete) return;
                if (strength > 0) {
                    strength = Math.max(0, strength - DECREASE_RATE);
                }
                updateUI();
            }, TICK_RATE);
        }
        if (input === lastInput) return; // Must alternate buttons

        const now = Date.now();
        lastInput = input;
        strength = Math.min(MAX_STRENGTH, strength + INCREASE_AMOUNT);
        updateUI();
        if (strength >= MAX_STRENGTH) completeGame();
    }

    function completeGame() {
        gameComplete = true;
        const totalSeconds = Math.floor((Date.now() - startTime) / 1000);

        strength = MAX_STRENGTH;
        updateUI();
        statusText.textContent = "ðŸ’ª MAXIMUM STRENGTH!";

        fetch("/minigame/strength/complete", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': [[${_csrf.token}]]
            },
            body: JSON.stringify({
                gargoyleId: gargoyleId,
                survivalTime: totalSeconds
            })
        }).then(() => {
            setTimeout(() => {
                window.location.href = "/minigame/strength/result-page?time=" + totalSeconds + "&gargoyleId=" + gargoyleId;
            }, 1000);
        });
    }

    document.addEventListener("keydown", (e) => {
        if (e.code === "ArrowLeft") handleInput("LEFT");
        if (e.code === "ArrowRight") handleInput("RIGHT");
    });

    document.getElementById("leftBtn").addEventListener("pointerdown", () => handleInput("LEFT"));
    document.getElementById("rightBtn").addEventListener("pointerdown", () => handleInput("RIGHT"));

    // Gravity: Meter drains over time
    setInterval(() => {
        if (gameComplete) return;
        if (strength > 0) {
            strength = Math.max(0, strength - DECREASE_RATE);
            updateUI();
        }
    }, TICK_RATE);

    document.getElementById("cancelBtn").addEventListener("click", () => {
    window.location.href = "/game";
});

</script>

</body>
</html>
