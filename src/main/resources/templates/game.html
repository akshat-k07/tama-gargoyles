<!-- src/main/resources/templates/game.html -->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="tg-poll-seconds" content="15">

    <title>Tama Gargoyles - Game</title>

    <link rel="stylesheet" th:href="@{/css/game.css}" />
</head>

<body>


<main id="main" class="screen">

    <!-- TOP HUD -->
    <header class="hud-top" aria-label="Gargoyle overview">
        <div class="hud-top__left">
            <h1 class="game-title">Tama Gargoyles</h1>

            <div class="meta" aria-label="Creature metadata">
                <span>
                    <strong>Creature:</strong>
                    <span th:text="${gargoyle.name}">Pebble</span>
                </span>

                <span>
                    <strong>Stage:</strong>
                    <span th:text="${gargoyle.type.name() == 'CHILD' ? 'CHILD' : 'ADULT'}">CHILD</span>
                </span>

                <span th:if="${gargoyle.type.name() != 'CHILD'}">
                    <strong>Outcome:</strong>
                    <span th:text="${gargoyle.type.name()}">GOOD</span>
                </span>
            </div>
        </div>

        <div class="hud-top__right">
            <div class="meta">
                <span>
                    <strong>Age:</strong>
                    Day <span th:text="${gameDaysOld}">0</span>,
                    Min <span th:text="${minutesIntoDay}">0</span>
                </span>

                <span class="chip"
                      th:classappend="${gargoyle.paused} ? ' chip--warn' : ' chip--ok'">
                    <span th:text="${gargoyle.paused} ? 'PAUSED' : 'RUNNING'">RUNNING</span>
                </span>
            </div>

            <nav class="hud-links" aria-label="Game links">
                <a th:href="@{/gargoyle/{id}/rename(id=${gargoyle.id})}">Rename</a>

                <a th:if="${gargoyle.type.name() == 'GOOD' or gargoyle.type.name() == 'BAD'}"
                   th:href="@{/battle}">
                    Battle
                </a>

                <!-- Testing mode toggle (AJAX ‚Äì no page reload) -->
                <form th:action="@{/testing-mode/toggle}"
                      method="post"
                      class="hud-links__form"
                      data-ajax="true">

                    <input type="hidden"
                           th:name="${_csrf.parameterName}"
                           th:value="${_csrf.token}"/>

                    <button type="submit"
                            class="btn btn--chip"
                            th:classappend="${testingMode} ? ' btn--chip-on' : ' btn--chip-off'"
                            th:attr="aria-pressed=${testingMode}">

        <span th:text="${testingMode} ? 'üß™ Testing: ON' : 'üß™ Testing: OFF'">
            üß™ Testing: OFF
        </span>
                    </button>
                </form>


                <!-- Pause & Exit -->
                <form class="hud-form" th:action="@{/gargoyles/pause}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button class="nav-btn nav-btn--primary" type="submit" title="Pause the game and return">
                        Pause &amp; Exit
                    </button>
                </form>
            </nav>

            <p class="hint hint--top" th:if="${gargoyle.type.name() == 'CHILD'}">
                üîí Battle unlocks when you evolve.
            </p>
        </div>
    </header>

    <!-- GAME GRID -->
    <div class="game-grid" id="game-grid">

        <!-- LEFT HUD: STATUS + TRAITS -->
        <section class="panel hud-panel hud-panel--left" aria-label="Status and traits">
            <h2 class="panel__title">Status</h2>

            <div class="stats-compact" aria-label="Core stats">

                <!-- Health -->
                <div class="stat">
                    <div class="stat__row">
                        <span class="stat__label">Health</span>
                        <span class="stat__value" th:text="${gargoyle.health} + '%'">90%</span>
                    </div>
                    <div class="meter"
                         th:classappend="${gargoyle.health < 25} ? ' meter--danger' : (${gargoyle.health < 50} ? ' meter--warn' : '')">
                        <div class="meter__fill" th:style="'width:' + ${gargoyle.health} + '%'"></div>
                    </div>
                </div>

                <!-- Hunger -->
                <div class="stat">
                    <div class="stat__row">
                        <span class="stat__label">Hunger</span>
                        <span class="stat__value" th:text="${gargoyle.hunger} + '%'">62%</span>
                    </div>
                    <div class="meter"
                         th:classappend="${gargoyle.hunger < 25} ? ' meter--danger' : (${gargoyle.hunger < 50} ? ' meter--warn' : '')">
                        <div class="meter__fill" th:style="'width:' + ${gargoyle.hunger} + '%'"></div>
                    </div>
                </div>

                <!-- Happiness -->
                <div class="stat">
                    <div class="stat__row">
                        <span class="stat__label">Happiness</span>
                        <span class="stat__value" th:text="${gargoyle.happiness} + '%'">80%</span>
                    </div>
                    <div class="meter"
                         th:classappend="${gargoyle.happiness < 25} ? ' meter--danger' : (${gargoyle.happiness < 50} ? ' meter--warn' : '')">
                        <div class="meter__fill" th:style="'width:' + ${gargoyle.happiness} + '%'"></div>
                    </div>
                </div>
            </div>

            <div class="panel__divider"></div>

            <h2 class="panel__title">Traits</h2>

            <div class="traits-compact" aria-label="Traits">
                <div class="stat">
                    <div class="stat__row">
                        <span class="stat__label">Strength</span>
                        <span class="stat__value" th:text="${gargoyle.strength} + '%'">25%</span>
                    </div>
                    <div class="meter">
                        <div class="meter__fill" th:style="'width:' + ${gargoyle.strength} + '%'"></div>
                    </div>
                </div>

                <div class="stat">
                    <div class="stat__row">
                        <span class="stat__label">Speed</span>
                        <span class="stat__value" th:text="${gargoyle.speed} + '%'">10%</span>
                    </div>
                    <div class="meter">
                        <div class="meter__fill" th:style="'width:' + ${gargoyle.speed} + '%'"></div>
                    </div>
                </div>

                <div class="stat">
                    <div class="stat__row">
                        <span class="stat__label">Brains</span>
                        <span class="stat__value" th:text="${gargoyle.intelligence} + '%'">10%</span>
                    </div>
                    <div class="meter">
                        <div class="meter__fill" th:style="'width:' + ${gargoyle.intelligence} + '%'"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- CENTER: STAGE -->
        <section class="stage-panel panel" aria-labelledby="creature-area-title">
            <h2 id="creature-area-title" class="sr-only">Creature</h2>

            <div class="stage" role="img" aria-label="Gargoyle on a church roof under a starry sky">
                <!-- Parallax layers -->
                <div class="stage__layer stage__sky" aria-hidden="true"></div>
                <div class="stage__layer stage__stars" aria-hidden="true"></div>
                <div class="stage__layer stage__moon" aria-hidden="true"></div>
                <div class="stage__layer stage__roof" aria-hidden="true"></div>

                <!-- Creature (PNG placeholder) -->
                <div class="creature-slot">
                    <img class="creature-sprite bob"
                         th:src="@{/images/gargoyle/gargoyle.png}"
                         alt="Your gargoyle">
                </div>

                <!-- Overlays -->
                <p class="overlay overlay--left" th:if="${gargoyle.hunger < 50}">
                    ‚ö† Hungry soon
                </p>

                <p class="overlay overlay--right"
                   th:if="${gargoyle.hunger >= 60 and gargoyle.happiness >= 60}">
                    ‚ú® Well cared for
                </p>

                <!-- subtle FX layer -->
                <div class="stage__layer stage__fx" aria-hidden="true"></div>
            </div>
        </section>

        <!-- RIGHT HUD: TIP + TESTING -->
        <aside class="panel hud-panel hud-panel--right" aria-label="Tips and testing">
            <h2 class="panel__title">Tip</h2>
            <p class="tip">
                Try different combos. Your gargoyle‚Äôs vibe will emerge over time ‚ú®
            </p>

            <div class="testing-panel" th:if="${testingMode}" aria-label="Testing tools">
                <h4 class="testing-title">üß™ Testing Tools</h4>
                <p class="testing-sub">Use these to simulate mistakes safely.</p>

                <div class="testing-buttons testing-actions">
                    <form action="/hunger-decrease" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" name="gargoyleId" th:value="${gargoyle.id}"/>
                        <input type="hidden" name="delta" value="10"/>
                        <button class="btn btn--danger btn--wide" type="submit" title="Decrease hunger by 10">
                            ‚Ü©Ô∏è Un-Feed
                        </button>
                    </form>

                    <form action="/entertainment-decrease" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" name="gargoyleId" th:value="${gargoyle.id}"/>
                        <input type="hidden" name="delta" value="10"/>
                        <button class="btn btn--danger btn--wide" type="submit" title="Decrease happiness by 10">
                            ‚Ü©Ô∏è Un-Play
                        </button>
                    </form>
                </div>

                <hr class="testing-divider"/>

                <div class="tester-stats" aria-label="Tester stats">
                    <h4 class="tester-stats__title">üìã Tester Stats</h4>

                    <ul class="tester-stats__list">
                        <li><strong>ID:</strong> <span th:text="${gargoyle.id}">1</span></li>
                        <li><strong>Status:</strong> <span th:text="${gargoyle.status}">ACTIVE</span></li>
                        <li><strong>Paused:</strong> <span th:text="${gargoyle.paused}">false</span></li>
                        <li>
                            <strong>Age (derived):</strong>
                            Day <span th:text="${gameDaysOld}">0</span>,
                            Min <span th:text="${minutesIntoDay}">0</span>
                        </li>
                        <li><strong>Active Minutes:</strong> <span th:text="${gargoyle.activeMinutes}">0</span></li>
                        <li><strong>Last Tick:</strong> <span th:text="${gargoyle.lastTickAt}">-</span></li>
                        <li><strong>Paused At:</strong> <span th:text="${gargoyle.pausedAt}">-</span></li>
                    </ul>
                </div>
            </div>
        </aside>

        <!-- ACTIONS -->
        <section class="panel actions-panel" aria-label="Actions">
            <div class="actions-wrap">

                <!-- FEED -->
                <div class="actions__group actions__group--feed" aria-labelledby="feed-title">
                    <h3 id="feed-title">Feed</h3>
                    <p class="actions__sub">Pick a snack to shape your gargoyle‚Äôs growth ‚ú®</p>

                    <div class="actions__icons" role="group" aria-label="Feed options">
                        <form action="/rocks-increase" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <input type="hidden" name="gargoyleId" th:value="${gargoyle.id}"/>
                            <input type="hidden" name="strengthDelta" value="4"/>
                            <input type="hidden" name="speedDelta" value="-1"/>
                            <input type="hidden" name="intelligenceDelta" value="-1"/>
                            <input type="hidden" name="hungerDelta" value="12"/>
                            <input type="hidden" name="userId" th:value="${gargoyle.user.id}"/>
                            <button class="icon-btn icon-btn--feed" type="submit" title="Feed Rocks: Adds Strength, minus Speed, minus Intelligence" aria-label="Feed Rocks">
                                <span class="icon" aria-hidden="true">ü™®</span>
                                <span class="sr-only">Feed Rocks</span>
                            </button>
                            <div class="icon-label" aria-hidden="true">
                                Rocks <span class="count" th:text="${rocksCount}">0</span>
                            </div>
                        </form>

                        <form action="/bugs-increase" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <input type="hidden" name="gargoyleId" th:value="${gargoyle.id}"/>
                            <input type="hidden" name="strengthDelta" value="-1"/>
                            <input type="hidden" name="speedDelta" value="4"/>
                            <input type="hidden" name="intelligenceDelta" value="-1"/>
                            <input type="hidden" name="hungerDelta" value="5"/>
                            <input type="hidden" name="userId" th:value="${gargoyle.user.id}"/>
                            <button class="icon-btn icon-btn--feed" type="submit" title="Feed Bugs: Adds Speed, minus Strength, minus Intelligence" aria-label="Feed Bugs">
                                <span class="icon" aria-hidden="true">üêõ</span>
                                <span class="sr-only">Feed Bugs</span>
                            </button>
                            <div class="icon-label" aria-hidden="true">
                                Bugs <span class="count" th:text="${bugsCount}">0</span>
                            </div>
                        </form>

                        <form action="/fruits-increase" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <input type="hidden" name="gargoyleId" th:value="${gargoyle.id}"/>
                            <input type="hidden" name="strengthDelta" value="-1"/>
                            <input type="hidden" name="speedDelta" value="-1"/>
                            <input type="hidden" name="intelligenceDelta" value="4"/>
                            <input type="hidden" name="hungerDelta" value="9"/>
                            <input type="hidden" name="userId" th:value="${gargoyle.user.id}"/>
                            <button class="icon-btn icon-btn--feed" type="submit" title="Feed Fruit: Adds Intelligence, minus Strength, minus Speed" aria-label="Feed Fruit">
                                <span class="icon" aria-hidden="true">üçé</span>
                                <span class="sr-only">Feed Fruit</span>
                            </button>
                            <div class="icon-label" aria-hidden="true">
                                Fruit <span class="count" th:text="${fruitsCount}">0</span>
                            </div>
                        </form>

                        <form action="/mystery-increase" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <input type="hidden" name="gargoyleId" th:value="${gargoyle.id}"/>
                            <input type="hidden" name="hungerDelta" value="100"/>
                            <input type="hidden" name="userId" th:value="${gargoyle.user.id}"/>
                            <button class="icon-btn icon-btn--mystery" type="submit" title="Feed Mystery Food: ???" aria-label="Feed Mystery">
                                <span class="icon" aria-hidden="true">‚ùì</span>
                                <span class="sr-only">Feed Mystery</span>
                            </button>
                            <div class="icon-label" aria-hidden="true">
                                Mystery <span class="count" th:text="${mysteryCount}">0</span>
                            </div>
                        </form>
                    </div>
                </div>


                <!-- PLAY -->
                <div class="actions__group actions__group--play" aria-labelledby="play-title">
                    <h3 id="play-title">Play</h3>
                    <p class="actions__sub">Mini-games boost happiness (and sometimes stats!)</p>

                    <div class="actions__icons" role="group" aria-label="Play options">
                        <form action="/strength-increase" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <input type="hidden" name="gargoyleId" th:value="${gargoyle.id}"/>
                            <input type="hidden" name="strengthDelta" value="10"/>
                            <input type="hidden" name="speedDelta" value="0"/>
                            <input type="hidden" name="intelligenceDelta" value="0"/>
                            <input type="hidden" name="happinessDelta" value="10"/>
                            <button class="icon-btn icon-btn--play" type="submit" title="Strength Game: +Strength" aria-label="Play Strength game">
                                <span class="icon" aria-hidden="true">üí™</span>
                                <span class="sr-only">Strength</span>
                            </button>
                            <div class="icon-label" aria-hidden="true">Strength</div>
                        </form>

                        <div class="action-item">
                            <button class="icon-btn icon-btn--play"
                                    type="button"
                                    th:onclick="|window.location.href='@{/pong/pong(gargoyleId=${gargoyle.id})}'|"
                                    title="Speed Game: +Speed"
                                    aria-label="Play Speed game">
                                <span class="icon" aria-hidden="true">‚ö°</span>
                                <span class="sr-only">Speed</span>
                            </button>
                            <div class="icon-label" aria-hidden="true">Speed</div>
                        </div>

                        <form action="/intelligence-increase" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <input type="hidden" name="gargoyleId" th:value="${gargoyle.id}"/>
                            <input type="hidden" name="strengthDelta" value="0"/>
                            <input type="hidden" name="speedDelta" value="0"/>
                            <input type="hidden" name="intelligenceDelta" value="10"/>
                            <input type="hidden" name="happinessDelta" value="10"/>
                            <button class="icon-btn icon-btn--play" type="submit" title="Brains Game: +Intelligence" aria-label="Play Brains game">
                                <span class="icon" aria-hidden="true">üß†</span>
                                <span class="sr-only">Brains</span>
                            </button>
                            <div class="icon-label" aria-hidden="true">Brains</div>
                        </form>
                    </div>
                </div>

                <div class="actions__group actions__group--side" aria-label="Quick tip">
                    <h3>Quick Tip</h3>
                    <p class="hint">Try feeding + playing in different orders ‚ú®</p>
                </div>

            </div>
        </section>

        <!-- EVENT LOG -->
        <section class="panel log-panel" aria-label="Event log">
            <h3>Event Log</h3>

            <ul class="log__list">
                <li th:if="${flashMessage}" th:text="${flashMessage}">You fed your gargoyle!</li>
                <li th:unless="${flashMessage}">Tip: refresh after ~1 minute to see decay while RUNNING.</li>
                <li th:if="${gargoyle.type.name() == 'CHILD'}">Battle unlocks when you become an adult.</li>
            </ul>

            <details class="debug" th:if="${testingMode}">
                <summary>Debug</summary>
                <p><strong>Type (raw):</strong> <span th:text="${gargoyle.type}">CHILD</span></p>
                <p><strong>Last Tick:</strong> <span th:text="${gargoyle.lastTickAt}">-</span></p>
                <p><strong>Paused At:</strong> <span th:text="${gargoyle.pausedAt}">-</span></p>
                <p><strong>Active Minutes:</strong> <span th:text="${gargoyle.activeMinutes}">0</span></p>
            </details>
        </section>

    </div>

</main>

<script>
    // ==========================================================
    // Tama Gargoyles UI: Phase 1 (AJAX actions) + Phase 2 (polling)
    // Goal: No full reloads + stats/overlays update over time.
    // ==========================================================

    const POLL_SECONDS = (() => {
      const meta = document.querySelector('meta[name="tg-poll-seconds"]');
      const s = meta ? Number(meta.content) : 15;
      return Number.isFinite(s) && s > 0 ? s : 15;
    })();

    let pollTimer = null;
    let pollInFlight = false;

    function extractAndPatch(htmlText) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlText, "text/html");

      const newHud = doc.querySelector(".hud-top");
      const oldHud = document.querySelector(".hud-top");
      if (newHud && oldHud) oldHud.replaceWith(newHud);


      const newLeft = doc.querySelector(".hud-panel--left");
      const oldLeft = document.querySelector(".hud-panel--left");
      if (newLeft && oldLeft) oldLeft.replaceWith(newLeft);

      const newRight = doc.querySelector(".hud-panel--right");
      const oldRight = document.querySelector(".hud-panel--right");
      if (newRight && oldRight) oldRight.replaceWith(newRight);

      const newLog = doc.querySelector(".log-panel");
      const oldLog = document.querySelector(".log-panel");
      if (newLog && oldLog) oldLog.replaceWith(newLog);

      const newStage = doc.querySelector(".stage");
      const oldStage = document.querySelector(".stage");
      if (newStage && oldStage) {
        oldStage.querySelectorAll(".overlay").forEach(o => o.remove());
        newStage.querySelectorAll(".overlay").forEach(o => oldStage.appendChild(o));
      }

      ajaxify();
    }

    async function fetchAndPatch() {
      if (pollInFlight) return;
      if (document.hidden) return;

      pollInFlight = true;
      try {
        const res = await fetch(window.location.href, {
          headers: { "X-Requested-With": "fetch" }
        });
        if (!res.ok) throw new Error("poll GET failed");
        const html = await res.text();
        extractAndPatch(html);
      } catch (e) {
        // skip
      } finally {
        pollInFlight = false;
      }
    }

    function startPolling() {
      stopPolling();
      pollTimer = setInterval(fetchAndPatch, POLL_SECONDS * 1000);
    }

    function stopPolling() {
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = null;
    }

    function ajaxify() {
      const forms = document.querySelectorAll(
        ".actions__icons form, .testing-buttons form, .testing-actions form"
      );

      forms.forEach((form) => {
        if (form.dataset.ajaxBound === "true") return;
        form.dataset.ajaxBound = "true";

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          try {
            const formData = new FormData(form);

            const postRes = await fetch(form.action, {
              method: (form.method || "POST").toUpperCase(),
              body: formData,
              headers: { "X-Requested-With": "fetch" }
            });

            if (!postRes.ok) throw new Error("POST failed");

            await fetchAndPatch();
          } catch (err) {
            window.location.reload();
          }
        });
      });
    }

    document.addEventListener("visibilitychange", () => {
      if (document.hidden) {
        stopPolling();
      } else {
        fetchAndPatch();
        startPolling();
      }
    });

    ajaxify();
    fetchAndPatch();
    startPolling();
</script>
<script th:src="@{/js/inventory-live.js}"></script>
</body>
</html>